<!DOCTYPE html>
<html>
<head>
	<title>Death 'til the Break of Dawn</title>
	<script src="processing-1.3.6.js"></script>

<style type="text/css" media="screen">
	.the_thing {
		position: relative;
	}

/*
	.click_me {
		position: absolute;
		top: 50px;
		left: 100px;
	}
*/

	.label {
		position: absolute;
		font-family: fixed;
	}
	
	.spacer {
		position: absolute;
	}
	
	.text_input {
		position: absolute;
	}
	
	.button {
	   position: absolute;
	   border-top: 1px solid #7d7d7d;
	   background: #828282;
	   background: -webkit-gradient(linear, left top, left bottom, from(#000000), to(#828282));
	   background: -webkit-linear-gradient(top, #000000, #828282);
	   background: -moz-linear-gradient(top, #000000, #828282);
	   background: -ms-linear-gradient(top, #000000, #828282);
	   background: -o-linear-gradient(top, #000000, #828282);
	   padding: 5px 10px;
	   -webkit-border-radius: 8px;
	   -moz-border-radius: 8px;
	   border-radius: 8px;
	   -webkit-box-shadow: rgba(0,0,0,1) 0 1px 0;
	   -moz-box-shadow: rgba(0,0,0,1) 0 1px 0;
	   box-shadow: rgba(0,0,0,1) 0 1px 0;
	   text-shadow: rgba(0,0,0,.4) 0 1px 0;
	   color: white;
	   font-size: 14px;
	   font-family: Georgia, serif;
	   text-decoration: none;
	   vertical-align: middle;
	   }
	.button:hover {
	   border-top-color: #807e7e;
	   background: #807e7e;
	   color: #ccc;
	   }
	.button:active {
	   border-top-color: #f70000;
	   background: #f70000;
	   }
</style>
</head>

<body>
<!-- <h2>to be named</h2> -->

<div class="the_thing">
	<canvas id="canvas1" width="512" height="384"></canvas>
	
	<div class="spacer"; style="left:10px; top:327px;">
		<div class="label" style="left:39px; top:0px; color:White; font-size:12px">Angle:</div>
		<form>
			<input id="AngleValue" class="text_input" type="text" size=3 value="123" style="left:33px; top:21px;"></input>
		</form>
		<a id="AngleMinus" href="#" class="button" style="left:0px; top:18px">-</a>
		<a id="AnglePlus" href="#" class="button" style="left:80px; top:18px">+</a>
	</div>
	
	<div class="spacer"; style="left:190px; top:327px;">
		<div class="label" style="left:39px; top:0px; color:White; font-size:12px">Power:</div>
		<form>
			<input id="PowerValue" class="text_input" type="text" size=3 value="100" style="left:33px; top:21px;"></input>
		</form>
		<a id="PowerMinus" href="#" class="button" style="left:0px; top:18px">-</a>
		<a id="PowerPlus" href="#" class="button" style="left:80px; top:18px">+</a>
	</div>
	
	<a id="FireButton" href="#" class="button" style="left:370px; top:345px">Fire Ze Missile!</a>
</div>

<script id="script1" type="text/javascript">

// Simple way to attach js code to the canvas is by using a function
function sketchProc(processing) {

	// Constants
	const ScreenWidth = 512;
	const ScreenHeight = 384;
	const Colors = {
		"Blue": processing.color(0, 0, 255),
		"Red": processing.color(255, 0, 0),
		"Yellow": processing.color(255, 255, 0)
	};
	const DefaultAngle = -40;
	const DefaultPower = 160;
	const GravityY = 100;
	const DefaultExplosionRadius = 10;
	const DefaultExplosionDuration = 2;
	// const GameStates = {
	// 	""
	// };
	
	// Timing
	var UpdateDurationS = 0.05;		// time to elapse when updating game state, sort-of approximately in seconds
	
	// Layers, listed in draw order
	var BackgroundLayer;
	var TerrainLayer;
	var ShotLayer;
	
	// Images
	var Background_1_Image;
	
	// Game Objects
	var Tanks = new Array();
	var CurrentTank = null;
	var Missiles = new Array();
	var DeadMissiles = new Array();
	var Explosions = new Array();
	var DeadExplosions = new Array();
	
	// Delayed Deletion
	function Destroy(object, deadObjects) {
		deadObjects.push(object);
	}

	function CollectGarbage(liveObjects, deadObjects) {
		for (var i = 0; i < deadObjects.length; i++) {
			for (var j = 0; j < liveObjects.length; j++) {
				if (deadObjects[i] == liveObjects[j]) {
					liveObjects.splice(j, 1);
				}
			}
		}
		deadObjects.splice(0, deadObjects.length);
	}
	
	
	// Tank class
	function Tank(cx, cy, color) {
		this.cx = cx;
		this.cy = cy;
		this.width = 16;
		this.height = 10;
		
		if (color == null) {
			color = processing.color(255, 0, 0);
		}
		this.color = color;
	}
	
	Tank.prototype.draw = function () {
		//console.log("draw tank at " + this.x + ", " + this.y);
		processing.rectMode(processing.CENTER);
		processing.fill(this.color);
		processing.noStroke();
		processing.rect(this.cx,
						this.cy,
						this.width,
						this.height);
	}
	
	
	// Explosion class
	function Explosion(x, y, radius) {
		this.x = x;
		this.y = y;
		
		if (radius == null) {
			radius = DefaultExplosionRadius;
		}
		this.radius = radius;
		
		this.timeRemaining = DefaultExplosionDuration;
		this.wasDrawn = false;
	}
	
	Explosion.prototype.update = function () {
		this.timeRemaining -= UpdateDurationS;
		if (this.timeRemaining <= 0) {
			Destroy(this, DeadExplosions);
		}
	}
	
	Explosion.prototype.draw = function () {
		// if ( ! this.wasDrawn ) {
		// 	ShotLayer.beginDraw();
		// 	ShotLayer.ellipseMode(processing.CENTER);
		// 	ShotLayer.fill(Colors.Yellow);
		// 	ShotLayer.ellipse(this.x, this.y, this.radius * 2, this.radius * 2);
		// 	ShotLayer.endDraw();
		// 	this.wasDrawn = true;
		// }

		processing.ellipseMode(processing.CENTER);
		processing.fill(Colors.Yellow);
		processing.ellipse(this.x, this.y, this.radius * 2, this.radius * 2);

	}
	
	
	// Missile class
	function Missile(startx, starty, vx, vy) {
		this.lastx = startx;
		this.lasty = starty;
		this.x = startx;
		this.y = starty;
		this.vx = vx;
		this.vy = vy;
		this.alive = true;
	}
	
	Missile.prototype.update = function () {
		this.lastx = this.x;
		this.lasty = this.y;
		this.x += (this.vx * UpdateDurationS);
		this.y += (this.vy * UpdateDurationS);
		this.vy += (GravityY * UpdateDurationS);
		
		// do collision detection against the ground
		// NOTE: Processing.js reverses the y-axis wrt. its get() function
		var detectedColor = TerrainLayer.get(this.x, (ScreenHeight-this.y));
		var detectedAlpha = processing.alpha(detectedColor);
		if (detectedAlpha > 0) {
			var explosion = new Explosion(this.x, this.y);
			Explosions.push(explosion);
			Destroy(this, DeadMissiles);
		}
	}
	
	Missile.prototype.draw = function () {
		ShotLayer.beginDraw();
		ShotLayer.stroke(Colors.Yellow);
		ShotLayer.line(this.lastx, this.lasty, this.x, this.y);
		ShotLayer.endDraw();
		
		// ShotLayer.rectMode(processing.CENTER);
		// ShotLayer.fill(Colors.Yellow);
		// ShotLayer.noStroke();
		// ShotLayer.rect(this.x,
		// 			   this.y,
		// 			   4,	// width
		// 			   4);	// height
	}
	
	// Angle + Power Getters and Setters
	
	function getAngle() {
		return parseInt(document.getElementById("AngleValue").value);
	}
	
	function setAngle(value) {
		document.getElementById("AngleValue").value = value;
	}
	
	function getPower() {
		return parseInt(document.getElementById("PowerValue").value);
	}
	
	function setPower(value) {
		document.getElementById("PowerValue").value = value;
	}
	
	// Button Handlers
	
	document.getElementById('AngleMinus').onclick = function() {
		var angle = getAngle();
		angle -= 2;
		setAngle(angle);
	}

	document.getElementById('AnglePlus').onclick = function() {
		var angle = getAngle();
		angle += 2;
		setAngle(angle);
	}
	
	document.getElementById('PowerMinus').onclick = function() {
		var power = getPower();
		power -= 10;
		setPower(power);
	}

	document.getElementById('PowerPlus').onclick = function() {
		var power = getPower();
		power += 10;
		setPower(power);
	}

	document.getElementById('FireButton').onclick = function() {
		var angleDeg = getAngle();
		var angleRad = processing.radians(angleDeg);
		var power = getPower();
		var x = CurrentTank.cx;
		var y = CurrentTank.cy;
		var vx = power * Math.cos(angleRad);
		var vy = power * Math.sin(angleRad);
		console.log("fire!: angle="+angleDeg+"; power="+power+"; x="+x+"; y="+y+"; vx="+vx+"; vy="+vy);
		var missile = new Missile(x, y, vx, vy);
		Missiles.push(missile);
	}
	
	// Init game
  	processing.setup = function () {
		console.log("setup called");
		
		processing.size(ScreenWidth, ScreenHeight);
		
		// Create PImages from pre-loaded images
		Background_1_Image = processing.loadImage("Assets/Images/Background_1.png");
		
		// var processingCode = "PImage TerrainLayer = createImage( 120, 120, RGB ); TerrainLayer.pixels[0] = color(1, 2, 3, 4);";
		// var jsCode = Processing.compile(processingCode).sourceCode;
		// console.log(jsCode);
		
		// Reset controls
		setAngle(DefaultAngle);
		setPower(DefaultPower);
		
		// Init Layers
		BackgroundLayer = processing.createGraphics(ScreenWidth, ScreenHeight, processing.P3D);
		BackgroundLayer.beginDraw();
		BackgroundLayer.background(0, 0, 0, 255);
		BackgroundLayer.endDraw();
		
		TerrainLayer = processing.createGraphics(ScreenWidth, ScreenHeight, processing.P3D);
		TerrainLayer.beginDraw();
		TerrainLayer.background(0, 0, 0, 0);			// fill with blank pixels
		TerrainLayer.image(Background_1_Image, 0, 0);	// draw the image on top of it
		TerrainLayer.endDraw();

		// processing.imageMode(processing.CORNER);
		// for (var y = 0; y < ScreenHeight; y++)
		// {
		// 	console.log("alpha,"+y+" = " + processing.red(TerrainLayer.get(20,y)));
		// }
		
		ShotLayer = processing.createGraphics(ScreenWidth, ScreenHeight, processing.P3D);
		ShotLayer.beginDraw();
		ShotLayer.background(0, 0, 0, 0);
		ShotLayer.endDraw();
		
		// Init Tanks
		Tanks.push(new Tank(60, 253, Colors.Blue));
		Tanks.push(new Tank(410, 288, Colors.Red));
		CurrentTank = Tanks[0];
		
		console.log("setup done!");
	}

	// Update and draw
	function Update() {
		//console.log("s: " + (processing.millis() / 1000));
		for (var i = 0; i < Missiles.length; i++) {
			Missiles[i].update();
		}
		for (var i = 0; i < Explosions.length; i++) {
			Explosions[i].update();
		}
	}
	
	processing.draw = function() {
		//console.log("s: " + (processing.millis() / 1000));
		
		// Update
		Update();
		
		// Draw
		processing.background(204);
		processing.image(BackgroundLayer, 0, 0);
		processing.image(TerrainLayer, 0, 0);
		for (var i = 0; i < Tanks.length; i++) {
			Tanks[i].draw();
		}
		for (var i = 0; i < Missiles.length; i++) {
			Missiles[i].draw();
		}
		processing.image(ShotLayer, 0, 0);
		for (var i = 0; i < Explosions.length; i++) {
			Explosions[i].draw();
		}
		
		// Clean up garbage
		CollectGarbage(Missiles, DeadMissiles);
		CollectGarbage(Explosions, DeadExplosions);
	};
}

sketch = new Processing.Sketch(sketchProc);
const NumImagesToLoad = 1;
var NumImagesLoaded = 0;
var Background_1 = new Image(),
    canvas1 = document.getElementById('canvas1'),
    sketch,
    processing;

function OnImageLoaded() {
	NumImagesLoaded++;
	if (NumImagesLoaded == NumImagesToLoad) {
		// Once all of the images are loaded, start the Processing sketch.
		processing = new Processing(canvas1, sketch);
	}
}

Background_1.onload = function() {
	sketch.imageCache.add("Assets/Images/Background_1.png", Background_1);
	OnImageLoaded();
};

Background_1.src = "Assets/Images/Background_1.png";

</script>

</body>
</html>
